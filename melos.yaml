name: dev_server
description: Dev Server monorepo with auto-update and GitHub integration
repository: https://github.com/MohamedAboElnasrHassan/dev_server

packages:
  - apps/*
  - packages/*

sdkPath: auto

command:
  bootstrap:
    usePubspecOverrides: true
    runPubGetInParallel: true

ide:
  intellij:
    enabled: true
  vscode:
    enabled: true

environment:
  sdk: ">=3.0.0 <4.0.0"
  flutter: ">=3.10.0"

scripts:
  # Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ·ÙˆÙŠØ±
  analyze:
    description: Run `flutter analyze` in all packages
    run: melos exec -- "flutter analyze"
    select-package:
      flutter: true
      dir-exists: lib

  format:
    description: Run `flutter format` in all packages
    run: melos exec -- "flutter format ."
    select-package:
      flutter: true
      dir-exists: lib

  lint:all:
    description: Run analyze and format on all packages
    run: |
      melos run analyze
      melos run format

  clean:deep:
    description: Clean all build and temporary files
    run: |
      git clean -x -d -f -q
      melos exec -- "flutter clean"

  clean:build:
    description: Clean build directories (app_build and build folders)
    run: |
      dart melos_runner.dart clean

  test:
    description: Run tests in all packages
    run: melos exec -- "flutter test"
    select-package:
      flutter: true
      dir-exists: test

  # Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡
  build:windows:
    description: Build Windows app
    run: |
      cd apps/dev_server_app && flutter build windows --release
    select-package:
      scope: "dev_server_app"

  build:macos:
    description: Build macOS app
    run: |
      cd apps/dev_server_app && flutter build macos --release
    select-package:
      scope: "dev_server_app"

  build:linux:
    description: Build Linux app
    run: |
      cd apps/dev_server_app && flutter build linux --release
    select-package:
      scope: "dev_server_app"

  build:android:
    description: Build Android app
    run: |
      cd apps/dev_server_app && flutter build apk --release
    select-package:
      scope: "dev_server_app"

  build:ios:
    description: Build iOS app
    run: |
      cd apps/dev_server_app && flutter build ios --release --no-codesign
    select-package:
      scope: "dev_server_app"

  build:all:
    description: Build all platforms
    run: |
      melos run build:windows
      melos run build:macos
      melos run build:linux
      melos run build:android
      melos run build:ios

  # Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ù†Ø´Ø±
  create:installer:
    description: Create installer package
    run: |
      echo "ðŸ’¾ Creating installer package..."

      # Use dart script to create installer
      dart melos_runner.dart run create:installer
    select-package:
      scope: "dev_server_app"

  # Ø£ÙˆØ§Ù…Ø± GitHub
  github:create-repo:
    description: Create GitHub repository
    run: |
      cd packages/tools_package && dart lib/github_tools.dart create
    select-package:
      scope: "tools_package"

  github:sync-config:
    description: Sync configuration with GitHub
    run: |
      cd packages/tools_package && dart lib/github_tools.dart sync
    select-package:
      scope: "tools_package"

  github:publish:
    description: Publish release to GitHub
    run: |
      cd packages/tools_package && dart lib/github_tools.dart publish 1.0.0 1
    select-package:
      scope: "tools_package"

  # Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  version:get:
    description: Get current version from app-config.json
    run: |
      cd packages/tools_package && dart lib/github_tools.dart version
    select-package:
      scope: "tools_package"

  version:bump:
    description: Bump version in app-config.json
    run: |
      cd packages/tools_package && dart lib/github_tools.dart bump
    select-package:
      scope: "tools_package"

  release:auto:
    description: Automatically create, build and publish a release
    run: |
      # Step 1: Build Windows app
      echo "ðŸš€ Step 1/3: Building Windows application..."
      melos run build:windows

      # Step 2: Create installer
      echo "ðŸ’¾ Step 2/3: Creating installer package..."
      melos run create:installer

      # Step 3: Publish to GitHub
      echo "ðŸ”– Step 3/3: Publishing release to GitHub..."
      cd packages/tools_package && dart lib/github_tools.dart auto 1.0.0 1

  release:tag:
    description: Create and push a new version tag
    run: |
      VERSION=$(cd packages/tools_package && dart lib/github_tools.dart version | grep -oP 'Version: \K[\d\.]+' || echo "1.0.0")
      echo "Creating tag v$VERSION"
      git tag -a "v$VERSION" -m "Release v$VERSION"
      git push origin "v$VERSION"
      echo "âœ… Tag v$VERSION created and pushed. GitHub Actions will now build and release automatically."
    select-package:
      scope: "tools_package"